<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Guhan Dental Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

  <!-- Header -->
  <div class="bg-white shadow p-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-blue-700 flex items-center gap-2">
      ü¶∑ Guhan Dental <span class="text-sm text-gray-400">Dashboard</span>
    </h1>
    <div id="userEmail" class="text-sm text-gray-500">Not signed in</div>
  </div>

  <!-- Google Sign-In -->
  <div id="signinDiv" class="flex justify-center py-10">
    <div id="g_id_onload"
         data-client_id="495253979256-tj4i9r7i8p1ee2girqllcuoaa261l0l3.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="popup"
         data-callback="onSignIn"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>
  </div>

  <!-- Spinner -->
  <div id="spinner" class="fixed inset-0 bg-white bg-opacity-70 flex justify-center items-center hidden z-50">
    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-600"></div>
  </div>

  <!-- Main Dashboard Content -->
  <div id="dashboardContent" class="max-w-6xl mx-auto p-6 hidden">
    <!-- Date Filter -->
    <div class="flex flex-col sm:flex-row items-center gap-4 justify-center mb-8">
      <input type="date" id="fromDate" class="p-2 border border-gray-300 rounded shadow-sm">
      <input type="date" id="toDate" class="p-2 border border-gray-300 rounded shadow-sm">
      <button onclick="fetchDashboard()" class="bg-blue-600 text-white px-4 py-2 rounded shadow">
        üîç Filter
      </button>
    </div>

    <!-- Metric Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white p-4 rounded-xl shadow text-center">
        <div class="text-blue-600">üë• Total Patients</div>
        <div id="totalPatients" class="text-2xl font-bold mt-1">--</div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow text-center">
        <div class="text-green-600">üÜï New Today</div>
        <div id="newPatientsToday" class="text-2xl font-bold mt-1">--</div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow text-center">
        <div class="text-purple-600">üí∞ Revenue</div>
        <div id="totalRevenue" class="text-2xl font-bold mt-1">--</div>
      </div>
      <div class="bg-white p-4 rounded-xl shadow text-center">
        <div class="text-red-600">‚è≥ Pending</div>
        <div id="pendingPayments" class="text-2xl font-bold mt-1">--</div>
      </div>
    </div>

    <!-- Chart -->
    <div class="bg-white p-4 rounded-xl shadow">
      <canvas id="dashboardChart" height="100"></canvas>
    </div>
  </div>

  <script>
    const ADMIN_EMAIL = "guhandental@gmail.com";

    function onSignIn(response) {
      const jwt = response.credential;
      const payload = JSON.parse(atob(jwt.split('.')[1]));
      const email = payload.email;
      document.getElementById("userEmail").textContent = email;

      if (email !== ADMIN_EMAIL) {
        alert("Access restricted to admin.");
        return;
      }

      document.getElementById("signinDiv").classList.add("hidden");
      document.getElementById("dashboardContent").classList.remove("hidden");

      const today = new Date();
      const lastWeek = new Date(today);
      lastWeek.setDate(today.getDate() - 6);

      document.getElementById("fromDate").value = lastWeek.toISOString().split("T")[0];
      document.getElementById("toDate").value = today.toISOString().split("T")[0];

      fetchDashboard();
    }

    async function fetchDashboard() {
      const spinner = document.getElementById("spinner");
      spinner.classList.remove("hidden");

      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;

      try {
        const url = `/.netlify/functions/submit-patient?action=getDashboardData&from=${from}&to=${to}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) throw new Error(data.error);

        document.getElementById("totalPatients").textContent = data.totalPatients;
        document.getElementById("newPatientsToday").textContent = data.newPatientsToday;
        document.getElementById("totalRevenue").textContent = "‚Çπ " + data.totalRevenue;
        document.getElementById("pendingPayments").textContent = "‚Çπ " + data.pendingPayments;

        drawChart(data);
      } catch (err) {
        alert("Error fetching dashboard: " + err.message);
      }

      spinner.classList.add("hidden");
    }

    function drawChart(data) {
      const ctx = document.getElementById("dashboardChart").getContext("2d");
      if (window.dashboardChart) window.dashboardChart.destroy();

      window.dashboardChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Total Patients", "New Today", "Revenue", "Pending"],
          datasets: [{
            label: "Overview",
            data: [
              data.totalPatients,
              data.newPatientsToday,
              data.totalRevenue,
              data.pendingPayments
            ],
            backgroundColor: ["#3b82f6", "#22c55e", "#8b5cf6", "#ef4444"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
  </script>
</body>
</html>
